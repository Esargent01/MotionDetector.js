/*!
 * MotionDetector.js v1.0
 * https://github.com/VodkaBears/motiondetector.js
 *
 * By VodkaBears(https://github.com/VodkaBears)
 *
 * Released under the MIT license
*/

function MotionDetector(g,u){var c=this,s,n,h,l,j,f,p,t,k,m,v=255,w=255,x=255,y=255,z=0,A=0,B=0,C=255;c.update=function(){j.drawImage(g,0,0,g.width,g.height);if(f)if(c.onUpdate)c.onUpdate(f);else f.clearRect(0,0,l.width,l.height);s=j.getImageData(0,0,k,m);n||(n=j.getImageData(0,0,k,m));p=j.createImageData(k,m);f&&(t=f.createImageData(k,m));var q=p.data,d=s.data,r=n.data,b;if(d.length==r.length)for(var a=0,h=0.25*d.length,e;a<h;a++)b=(d[4*a]+d[4*a+1]+d[4*a+2])/3,e=(r[4*a]+r[4*a+1]+r[4*a+2])/3,b=48< (b-e^b-e>>31)-(b-e>>31)?255:0,q[4*a]=b,q[4*a+1]=b,q[4*a+2]=b,q[4*a+3]=255,f&&(e=t.data,255===b?(e[4*a]=v,e[4*a+1]=w,e[4*a+2]=x,e[4*a+3]=y,c.onDifference&&(b={},b.i=a,b.y=~~(a/k),b.x=a-b.y*k,c.onDifference(f,b))):(e[4*a]=z,e[4*a+1]=A,e[4*a+2]=B,e[4*a+3]=C,c.onSimilarity&&(b={},b.i=a,b.y=~~(a/k),b.x=a-b.y*k,c.onSimilarity(f,b))));f&&(!c.onDifference&&!c.onSimilarity)&&f.putImageData(t,0,0);n=s};c.getBlended=function(){return p};c.getMotionAverage=function(c,d,f,b,a){var g=0,e=p.data;a=a||1;var h=~~d; for(d=~~(d+b);h<d;h+=a)for(var j=~~c,m=~~(c+f),l;j<m;j+=a)l=~~(4*j+4*h*k),g+=(e[l]+e[l+1]+e[l+2])/3;return 0.5+g/(f/a*(b/a))<<0};c.checkArea=function(f,d,g,b,a){return 100<c.getMotionAverage(f,d,g,b,a)};c.setColor=function(c,d){v=c.r;w=c.g;x=c.b;y=c.a;z=d.r;A=d.g;B=d.b;C=d.a;return this};c.onDifference=null;c.onSimilarity=null;c.onUpdate=null;0===g.width*g.height&&(g.width=640,g.height=480);k=g.width;m=g.height;h=document.createElement("canvas");j=h.getContext("2d");h.width=k;h.height=m;u&&(l=u,f= l.getContext("2d"),l.width=k,l.height=m);j.translate(h.width,0);j.scale(-1,1)};